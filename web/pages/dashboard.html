<section class="page">
    <header class="page-header">
        <h1>Dashboard</h1>
        <p>Snapshot of balances and activity.</p>
    </header>
    <div class="grid">
        <article class="card">
            <h2>Cash on Hand</h2>
            <p class="value">$128,430</p>
            <p class="meta">Updated <span data-last-updated>--</span></p>
        </article>
        <article class="card">
            <h2>Payables</h2>
            <p class="value">$32,910</p>
            <p class="meta">Due this month</p>
        </article>
        <article class="card">
            <h2>Receivables</h2>
            <p class="value">$48,250</p>
            <p class="meta">Aging 30-60 days</p>
        </article>
    </div>
    <% 
    let usersWithPendingApprovalsLength = users.filter(user => user.status === 'pending').length;
    let usersWithSuspendedAccountsLength = users.filter(user => user.status === 'suspended').length;
    let usersAvailableToSuspend = users.filter(user => user.status === 'active' && user.id !== currentUserId);
    %>
    <% if (role === "administrator") { %>
    <section class="stack">
        <header class="page-header">
            <h1>User Management</h1>
        </header>
        <div class="grid">
            <article class="card">
                <h2>User Approvals</h2>
                <% if (usersWithPendingApprovalsLength == 0) { %>
                <p class="meta">No pending user approvals</p>
                <% } %>
                <% users.filter(user => user.status === 'pending').forEach(user => { %>
                <article class="data-row" data-user_id-<%= user.id %>>
                    <p class="value">
                        <span class="approval-name"><%= user.username %></span>
                        <span class="approval-actions">
                            <button onclick="(async()=>{
                                let response = await fetch('/api/users/approve-user/' + <%= user.id %>, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                        'User_id': localStorage.getItem('user_id')
                                    }
                                });
                                if (response.ok) {
                                    alert('User approved successfully');
                                    document.querySelector('[data-user_id-<%= user.id %>]').remove();
                                } else {
                                    alert('Error approving user');
                                }
                            })()" class="button-small">Approve</button>
                            <button onclick="(async()=>{
                                let response = await fetch('/api/users/reject-user/' + <%= user.id %>, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                        'User_id': localStorage.getItem('user_id')
                                    }
                                });
                                if (response.ok) {
                                    alert('User rejected successfully');
                                    document.querySelector('[data-user_id-<%= user.id %>]').remove();
                                } else {
                                    alert('Error rejecting user');
                                }
                            })()" class="button-small">Reject</button>
                        </span>
                    </p>
                    <p class="meta">Pending since <%= user.created_at %></p>
                </article>
                <% }); %>
            </article>
            <article class="card">
                <h2>Users with Expired Passwords</h2>
                <% if (users.filter(user => user.password_expired).length == 0) { %>
                <p class="meta">No users with expired passwords</p>
                <% } %>
                <% for (let user of users.filter(user => user.password_expires_at < new Date())) { %>
                <article class="data-row">
                    <p class="value"><%= user.username %> <button class="button-small">Suspend User</button></p>
                    <p class="meta">Password Expired on <%= user.password_expires_at %></p>
                </article>
                <% } %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Suspended Users</h2>
                <% if (usersWithSuspendedAccountsLength == 0) { %>
                <p class="meta">No suspended user accounts</p>
                <% } %>
                <% users.filter(user => user.status === 'suspended').forEach(user => { %>
                <article class="data-row" data-suspended_user_id-<%= user.id %>>
                    <p class="value">
                        <span class="approval-name"><%= user.username %></span>
                        <span class="approval-actions">
                            <button onclick="(async()=>{
                                let response = await fetch('/api/users/reinstate-user/' + <%= user.id %>, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                        'User_id': localStorage.getItem('user_id')
                                    }
                                });
                                if (response.ok) {
                                    alert('User reinstated successfully');
                                    document.querySelector('[data-suspended_user_id-<%= user.id %>]').remove();
                                } else {
                                    alert('Error reinstating user');
                                }
                            })()" class="button-small">Reinstate</button>
                        </span>
                    </p>
                    <p class="meta">Ends <%= user.suspension_end_at %></p>
                </article>
                <% }); %>
            </article>
            <article class="card">
                <h2>Currently Logged-in Users</h2>
                <% if (loggedInUsers.length == 0) { %>
                <p class="meta">No users currently logged in</p>
                <% } %>
                <% loggedInUsers.forEach(user => { %>
                <article class="data-row">
                    <%let matchedUser = users.find(u => u.id === user.user_id);
                    if (matchedUser) { %>
                    <p class="value"><%= matchedUser.last_name %>, <%= matchedUser.first_name %></p>
                    <p class="meta">Username:
                        <%= matchedUser.username %><%
                        } else {
                            %>Unknown User<%
                        }
                        %></p>
                </article>
                <% }); %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>All Users</h2>
                <% users.forEach(user => { %>
                <article class="data-row">
                    <p class="value"><%= user.username %></p>
                </article>
                <% }); %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Create User</h2>
                <form id="create-user-form" class="stack" onsubmit="(async(event)=>{
                        event.preventDefault();
                        const profileImageInput = document.getElementById('user_icon');
                        let profileImageFilename = null;
                        if (profileImageInput.files.length > 0) {
                            profileImageFilename = profileImageInput.value.split('\\').pop();
                            console.log('Uploading profile image: ' + profileImageFilename);
                            console.log(profileImageInput);
                            const imageFormData = new FormData();
                            imageFormData.append('user_icon', profileImageInput.files[0]);
                            const imageResponse = await fetch('/images/upload-user-icon', {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                    'User_id': localStorage.getItem('user_id'),
                                },
                                body: imageFormData
                            });
                            if (!imageResponse.ok) {
                                const imageErrorData = await imageResponse.json();
                                alert('Error uploading profile image: ' + (imageErrorData.error || imageErrorData.message));
                            }
                        }
                        const form = document.getElementById('create-user-form');
                        const formData = new FormData(form);
                        formData.append('user_icon_name', profileImageFilename);
                        const response = await fetch('/api/users/create-user', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                'User_id': localStorage.getItem('user_id'),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(Object.fromEntries(formData))
                        });
                        if (response.ok) {
                            alert('User created successfully');
                            form.reset();
                        } else {
                            const errorData = await response.json();
                            alert('Error creating user: ' + errorData.message);
                        }
                        
                    })(event)">
                    <div class="field">
                        <label for="first_name">First Name</label>
                        <input type="text" id="first_name" name="first_name" required>
                    </div>
                    <div class="field">
                        <label for="last_name">Last Name</label>
                        <input type="text" id="last_name" name="last_name" required>
                    </div>
                    <div class="field">
                        <label for="Address">Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="field">
                        <label for="date_of_birth">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" required>
                    </div>
                    <div class="field">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="field">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="administrator">Administrator</option>
                            <option value="manager">Manager</option>
                            <option value="accountant">Accountant</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="user_icon">Profile Image</label>
                        <input type="file" id="user_icon" name="user_icon" accept="image/png, image/jpeg, image/jpg, image/gif">
                    </div>
                    <button type="submit">Create User</button>
                </form>
            </article>
            <div class="stack">
                <article class="card">
                    <h2>Delete User</h2>
                    <form id="delete-user-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <button type="submit">Delete User</button>
                    </form>            
                </article>
                <article class="card">
                    <h2>Reset User Password</h2>
                    <form id="reset-password-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <button type="submit">Reset Password</button>
                    </form>
                </article>
                <article class="card">
                    <h2>Suspend User Account</h2>
                    <form id="suspend-user-form" class="stack" onsubmit="((event)=>{
                        event.preventDefault();
                        const form = document.getElementById('suspend-user-form');
                        const formData = new FormData(form);
                        const usernameToSuspend = formData.get('suspend_username');
                        let userIdToSuspend = null;
                        <% usersAvailableToSuspend.forEach(user => { %>
                            if (usernameToSuspend === '<%= user.username %>') {
                                userIdToSuspend = <%= user.id %>;
                            }
                        <% }); %>
                        if(userIdToSuspend === null) {
                            alert('Invalid username selected');
                            return;
                        }
                        const suspensionStartRaw = formData.get('suspension_start_date');
                        const suspensionEndRaw = formData.get('suspension_end_date');
                        if (!userIdToSuspend || !suspensionStartRaw || !suspensionEndRaw) {
                            alert('Please fill in all fields');
                            return;
                        }
                        const suspensionStartDate = new Date(suspensionStartRaw);
                        const suspensionEndDate = new Date(suspensionEndRaw);
                        if (Number.isNaN(suspensionStartDate.getTime()) || Number.isNaN(suspensionEndDate.getTime())) {
                            alert('Please provide valid suspension dates');
                            return;
                        }
                        if(suspensionEndDate <= suspensionStartDate) {
                            alert('Suspension end date must be after start date');
                            return;
                        }
                        const suspensionData = {
                            userIdToSuspend: userIdToSuspend,
                            suspensionStart: suspensionStartDate.toISOString(),
                            suspensionEnd: suspensionEndDate.toISOString()
                        };
                        fetch('/api/users/suspend-user', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                'User_id': localStorage.getItem('user_id'),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(suspensionData)
                        }).then(response => {
                            if (response.ok) {
                                alert('User suspended successfully');
                                form.reset();
                            } else {
                                response.json().then(errorData => {
                                    alert('Error suspending user: ' + errorData.message);
                                });
                            }
                        }).finally(() => {
                            form.reset()
                        }).catch(error => {
                            alert('Error suspending user: ' + error.message);
                        });
                    })(event)">
                        <div class="field">
                            <label for="suspend_username">Username</label>
                            <select id="suspend_username" name="suspend_username" required>
                                <% if (usersAvailableToSuspend.length === 0) { %>
                                <option value="" disabled selected>No eligible users</option>
                                <% } else { %>
                                <option value="" disabled selected>Select a user</option>
                                <% usersAvailableToSuspend.forEach(user => { %>
                                <option value="<%= user.username %>"><%= user.username %></option>
                                <% }); %>
                                <% } %>
                            </select>
                        </div>
                        <div class="field">
                            <label for="suspension_start_date">Suspension Start Date/Time</label>
                            <input type="datetime-local" id="suspension_start_date" name="suspension_start_date" required>
                        </div>
                        <div class="field">
                            <label for="suspension_end_date">Suspension End Date/Time</label>
                            <input type="datetime-local" id="suspension_end_date" name="suspension_end_date" required>
                        </div>
                        <button type="submit">Suspend User</button>
                    </form>
                </article>
            </div>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Email User</h2>
                <form id="email-user-form" class="stack">
                    <div class="field">
                        <label for="email_username">To</label>
                        <select id="email_username" name="username" required>
                            <option value="" disabled selected>Select a user</option>
                            <% users.forEach(user => { %>
                            <option value="<%= user.username %>"><%= user.username %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="field">
                        <label for="subject">Subject</label>
                        <input type="text" id="subject" name="subject" required>
                    </div>
                    <div class="field">
                        <label for="message">Message</label>
                        <textarea id="message" name="message" required></textarea>
                    </div>
                    <button type="submit">Send Email</button>
            </article>
        </div>
    </section>
    <% } else { %>
    <section class="card">
        <h2>Your Workspace</h2>
        <p class="meta">Signed in as role: <%= role %></p>
        <div class="stack">
            <div class="notice">Your most recent transactions</div>
        </div>
    </section>
    <% } %>
</section>
