<section class="page">
    <header class="page-header">
        <h1>Dashboard</h1>
        <p>Snapshot of balances and activity.</p>
    </header>
    <div class="grid">
        <article class="card">
            <h2>Cash on Hand</h2>
            <p class="value">$128,430</p>
            <p class="meta">Updated <span data-last-updated>--</span></p>
        </article>
        <article class="card">
            <h2>Payables</h2>
            <p class="value">$32,910</p>
            <p class="meta">Due this month</p>
        </article>
        <article class="card">
            <h2>Receivables</h2>
            <p class="value">$48,250</p>
            <p class="meta">Aging 30-60 days</p>
        </article>
    </div>
    <% 
    let usersWithPendingApprovalsLength = users.filter(user => user.status === 'pending').length;
    let usersWithSuspendedAccountsLength = users.filter(user => user.status === 'suspended').length;
    %>
    <% if (role === "administrator") { %>
    <section class="stack">
        <h2>User Management</h2>
        <div class="grid">
            <article class="card">
                <h2>User Approvals</h2>
                <% if (usersWithPendingApprovalsLength == 0) { %>
                <p class="meta">No pending user approvals</p>
                <% } %>
                <% users.filter(user => user.status === 'pending').forEach(user => { %>
                <article class="data-row" data-user_id-<%= user.id %>>
                    <p class="value"><%= user.username %> <button onclick="(async()=>{
                        let response = await fetch('/api/users/approve-user/' + <%= user.id %>, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                                'User_id': localStorage.getItem('user_id')
                            }
                        });
                        if (response.ok) {
                            alert('User approved successfully');
                            // remove the user row from the DOM
                            document.querySelector('[data-user_id-<%= user.id %>]').remove();
                        } else {
                            alert('Error approving user');
                        }
                    })()" class="button-small">Approve</button></p>
                    <p class="meta">Pending since <%= user.created_at %></p>
                </article>
                <% }); %>
            </article>
            <article class="card">
                <h2>Users with Expired Passwords</h2>
                <% if (users.filter(user => user.password_expired).length == 0) { %>
                <p class="meta">No users with expired passwords</p>
                <% } %>
                <% for (let user of users.filter(user => user.password_expires_at < new Date())) { %>
                <article class="data-row">
                    <p class="value"><%= user.username %> <button class="button-small">Suspend User</button></p>
                    <p class="meta">Password Expired on <%= user.password_expires_at %></p>
                </article>
                <% } %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Suspended Users</h2>
                <% if (usersWithSuspendedAccountsLength == 0) { %>
                <p class="meta">No suspended user accounts</p>
                <% } %>
                <% users.filter(user => user.status === 'suspended').forEach(user => { %>
                <article class="data-row">
                    <p class="value"><%= user.username %></p>
                    <p class="meta">Ends <%= user.suspension_end_at %></p>
                </article>
                <% }); %>
            </article>
            <article class="card">
                <h2>Currently Logged-in Users</h2>
                <% if (loggedInUsers.length == 0) { %>
                <p class="meta">No users currently logged in</p>
                <% } %>
                <% loggedInUsers.forEach(user => { %>
                <article class="data-row">
                    <p class="value"><%
                        // get the username from the users array
                        let matchedUser = users.find(u => u.id === user.user_id);
                        if (matchedUser) {
                            %><%= matchedUser.username %><%
                        } else {
                            %>Unknown User<%
                        }
                        %></p>
                </article>
                <% }); %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>All Users</h2>
                <% users.forEach(user => { %>
                <article class="data-row">
                    <p class="value"><%= user.username %></p>
                </article>
                <% }); %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Create User</h2>
                <form id="create-user-form" class="stack">
                    <div class="field">
                        <label for="first_name">First Name</label>
                        <input type="text" id="first_name" name="first_name" required>
                    </div>
                    <div class="field">
                        <label for="last_name">Last Name</label>
                        <input type="text" id="last_name" name="last_name" required>
                    </div>
                    <div class="field">
                        <label for="Address">Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="field">
                        <label for="date_of_birth">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" required>
                    </div>
                    <div class="field">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="field">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="administrator">Administrator</option>
                            <option value="manager">Manager</option>
                            <option value="accountant">Accountant</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="profile_image">Profile Image</label>
                        <input type="file" id="profile_image" name="profile_image" accept="image/*">
                    </div>
                    <button type="submit">Create User</button>
                </form>
            </article>
            <div class="stack">
                <article class="card">
                    <h2>Delete User</h2>
                    <form id="delete-user-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <button type="submit">Delete User</button>
                    </form>            
                </article>
                <article class="card">
                    <h2>Reset User Password</h2>
                    <form id="reset-password-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <button type="submit">Reset Password</button>
                    </form>
                </article>
                <article class="card">
                    <h2>Suspend User Account</h2>
                    <form id="suspend-user-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <div class="field">
                            <label for="suspension_start_date">Suspension Start Date</label>
                            <input type="date" id="suspension_start_date" name="suspension_start_date" required>
                        </div>
                        <div class="field">
                            <label for="suspension_end_date">Suspension End Date</label>
                            <input type="date" id="suspension_end_date" name="suspension_end_date" required>
                        </div>
                        <button type="submit">Suspend User</button>
                    </form>
                </article>
            </div>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Email User</h2>
                <form id="email-user-form" class="stack">
                    <div class="field">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="field">
                        <label for="subject">Subject</label>
                        <input type="text" id="subject" name="subject" required>
                    </div>
                    <div class="field">
                        <label for="message">Message</label>
                        <textarea id="message" name="message" required></textarea>
                    </div>
                    <button type="submit">Send Email</button>
            </article>
        </div>
    </section>
    <% } else { %>
    <section class="card">
        <h2>Your Workspace</h2>
        <p class="meta">Signed in as role: <%= role %></p>
        <div class="stack">
            <div class="notice">Your most recent transactions</div>
        </div>
    </section>
    <% } %>
</section>
