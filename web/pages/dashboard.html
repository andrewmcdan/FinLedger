<section class="page">
    <header class="page-header">
        <h1>Dashboard</h1>
        <p>Snapshot of balances and activity.</p>
    </header>
    <div class="grid">
        <article class="card">
            <h2>Cash on Hand</h2>
            <p class="value">$128,430</p>
            <p class="meta">Updated <span data-last-updated>--</span></p>
        </article>
        <article class="card">
            <h2>Payables</h2>
            <p class="value">$32,910</p>
            <p class="meta">Due this month</p>
        </article>
        <article class="card">
            <h2>Receivables</h2>
            <p class="value">$48,250</p>
            <p class="meta">Aging 30-60 days</p>
        </article>
    </div>
    <% 
    let usersWithPendingApprovalsLength = users.filter(user => user.status === 'pending').length;
    let usersWithSuspendedAccountsLength = users.filter(user => user.status === 'suspended').length;
    let usersAvailableToSuspend = users.filter(user => user.status === 'active' && user.id !== currentUserId);
    %>
    <% if (role === "administrator") { %>
    <section class="stack">
        <header class="page-header">
            <h1>User Management</h1>
        </header>
        <div>
            <button type="button" data-refresh>Refresh data</button>
        </div>
        <div class="grid">
            <article class="card">
                <h2>User Approvals</h2>
                <% if (usersWithPendingApprovalsLength == 0) { %>
                <p class="meta">No pending user approvals</p>
                <% } %>
                <% users.filter(user => user.status === 'pending').forEach(user => { %>
                <article class="data-row" data-user_id-<%= user.id %>>
                    <p class="value">
                        <span class="approval-name"><span><%= user.username %></span><span class="meta"> (Full name: <%= user.first_name %> <%= user.last_name %>)</span></span>
                        <span class="approval-actions">
                            <button class="button-small" data-user-action="approve" data-user-id="<%= user.id %>">Approve</button>
                            <button class="button-small" data-user-action="reject" data-user-id="<%= user.id %>">Reject</button>
                        </span>
                    </p>
                    <p class="meta">Pending since <%= user.created_at %></p>
                </article>
                <% }); %>
            </article>
            <article class="card">
                <h2>Users with Expired Passwords</h2>
                <% if (users.filter(user => user.password_expired).length == 0) { %>
                <p class="meta">No users with expired passwords</p>
                <% } %>
                <% for (let user of users.filter(user => user.password_expires_at < new Date())) { %>
                <article class="data-row">
                    <p class="value"><span><%= user.username %></span><span class="meta"> (Full name: <%= user.first_name %> <%= user.last_name %>)</span><button class="button-small">Suspend User</button></p>
                    <p class="meta">Password Expired on <%= user.password_expires_at %></p>
                </article>
                <% } %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Suspended Users</h2>
                <% if (usersWithSuspendedAccountsLength == 0) { %>
                <p class="meta">No suspended user accounts</p>
                <% } %>
                <% users.filter(user => user.status === 'suspended').forEach(user => { %>
                <article class="data-row" data-suspended_user_id-<%= user.id %>>
                    <p class="value">
                        <span class="approval-name"><span><%= user.username %></span><span class="meta"> (Full name: <%= user.first_name %> <%= user.last_name %>)</span></span>
                        <span class="approval-actions">
                            <button class="button-small" data-user-action="reinstate" data-user-id="<%= user.id %>">Reinstate</button>
                        </span>
                    </p>
                    <p class="meta">Ends <%= user.suspension_end_at %></p>
                </article>
                <% }); %>
            </article>
            <article class="card">
                <h2>Currently Logged-in Users</h2>
                <% if (loggedInUsers.length == 0) { %>
                <p class="meta">No users currently logged in</p>
                <% } %>
                <% loggedInUsers.forEach(user => { %>
                <article class="data-row">
                    <%let matchedUser = users.find(u => u.id === user.user_id);
                    if (matchedUser) { %>
                    <p class="value"><%= matchedUser.last_name %>, <%= matchedUser.first_name %></p>
                    <p class="meta">Username:
                        <%= matchedUser.username %><%
                        } else {
                            %>Unknown User<%
                        }
                        %></p>
                </article>
                <% }); %>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>All Users</h2>
                <p class="meta">Click data to edit</p>
                <div class="table-scroll">
                    <table class="table table--wide">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Created At</th>
                                <th>Last Login</th>
                                <th>Password Expires At</th>
                                <th>Suspension Starts At</th>
                                <th>Suspension Ends At</th>
                                <th>Email</th>
                                <th>Date of Birth</th>
                                <th>Address</th>
                                <th>Temp Password</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach(user => { %>
                            <tr>
                                <td data-username-<%=user.id%>> <%=user.username%></td>
                                <td data-fullname-<%= user.id %>> <%= user.first_name %> <%= user.last_name %></td>
                                <td data-status-<%= user.id %>> <%= user.status %></td>
                                <td data-role-<%= user.id %>> <%= user.role %></td>
                                <td data-created-at-<%= user.id %>> <%= user.created_at %></td>
                                <td data-last_login_at-<%= user.id %>> <%= user.last_login_at %></td>
                                <td data-password_expires_at-<%= user.id %>> <%= user.password_expires_at ? user.password_expires_at : 'N/A' %></td>
                                <td data-suspension_start_at-<%= user.id %>> <%= user.suspension_start_at ? user.suspension_start_at : 'N/A' %></td>
                                <td data-suspension_end_at-<%= user.id %>> <%= user.suspension_end_at ? user.suspension_end_at : 'N/A' %></td>
                                <td data-email-<%= user.id %>> <%= user.email %></td>
                                <td data-date_of_birth-<%= user.id %>> <%= user.date_of_birth %></td>
                                <td data-address-<%= user.id %>> <%= user.address %></td>
                                <td data-temp_password-<%= user.id %>> <%= user.temp_password  ? 'True' : 'False' %></td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </article>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Create User</h2>
                <form id="create-user-form" class="stack">
                    <div class="field">
                        <label for="first_name">First Name</label>
                        <input type="text" id="first_name" name="first_name" required>
                    </div>
                    <div class="field">
                        <label for="last_name">Last Name</label>
                        <input type="text" id="last_name" name="last_name" required>
                    </div>
                    <div class="field">
                        <label for="Address">Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="field">
                        <label for="date_of_birth">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" required>
                    </div>
                    <div class="field">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="field">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="administrator">Administrator</option>
                            <option value="manager">Manager</option>
                            <option value="accountant">Accountant</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="user_icon">Profile Image</label>
                        <input type="file" id="user_icon" name="user_icon" accept="image/png, image/jpeg, image/jpg, image/gif">
                    </div>
                    <button type="submit">Create User</button>
                </form>
            </article>
            <div class="stack">
                <article class="card">
                    <h2>Delete User</h2>
                    <form id="delete-user-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <button type="submit">Delete User</button>
                    </form>            
                </article>
                <article class="card">
                    <h2>Reset User Password</h2>
                    <form id="reset-password-form" class="stack">
                        <div class="field">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <button type="submit">Reset Password</button>
                    </form>
                </article>
                <article class="card">
                    <h2>Suspend User Account</h2>
                    <form id="suspend-user-form" class="stack">
                        <div class="field">
                            <label for="suspend_username">Username</label>
                            <select id="suspend_username" name="suspend_username" required>
                                <% if (usersAvailableToSuspend.length === 0) { %>
                                <option value="" disabled selected>No eligible users</option>
                                <% } else { %>
                                <option value="" disabled selected>Select a user</option>
                                <% usersAvailableToSuspend.forEach(user => { %>
                                <option value="<%= user.username %>"><%= user.username %></option>
                                <% }); %>
                                <% } %>
                            </select>
                        </div>
                        <div class="field">
                            <label for="suspension_start_date">Suspension Start Date/Time</label>
                            <input type="datetime-local" id="suspension_start_date" name="suspension_start_date" required>
                        </div>
                        <div class="field">
                            <label for="suspension_end_date">Suspension End Date/Time</label>
                            <input type="datetime-local" id="suspension_end_date" name="suspension_end_date" required>
                        </div>
                        <button type="submit">Suspend User</button>
                    </form>
                </article>
            </div>
        </div>
        <div class="grid">
            <article class="card">
                <h2>Email User</h2>
                <form id="email-user-form" class="stack">
                    <div class="field">
                        <label for="email_username">To</label>
                        <select id="email_username" name="username" required>
                            <option value="" disabled selected>Select a user</option>
                            <% users.forEach(user => { %>
                            <option value="<%= user.username %>"><%= user.username %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="field">
                        <label for="subject">Subject</label>
                        <input type="text" id="subject" name="subject" required>
                    </div>
                    <div class="field">
                        <label for="message">Message</label>
                        <textarea id="message" name="message" required></textarea>
                    </div>
                    <button type="submit">Send Email</button>
            </article>
        </div>
    </section>
    <% } else { %>
    <section class="card">
        <h2>Your Workspace</h2>
        <p class="meta">Signed in as role: <%= role %></p>
        <div class="stack">
            <div class="notice">Your most recent transactions</div>
        </div>
    </section>
    <% } %>
</section>
<script id="users-data" type="application/json">
  <%- JSON.stringify({ users, currentUserId }).replaceAll("</", "<\\/") %>
</script>
