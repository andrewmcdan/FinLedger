<section class="page">
    <header class="page-header">
        <h1>Accounts List</h1>
        <p>Manage your accounts</p>
    </header>
    <% if (role === 'administrator') { %>
    <div class="page-actions">
        <button type="button" class="button-primary" id="add_account_button">Add New Account</button>
    </div>
    <% } %>
    <div class="stack">
        <div class="table-scroll">
            <table class="table table--wide" id="accounts_table">
                <thead>
                    <tr>
                        <th>Account Name</th>
                        <th>Account Owner</th>
                        <th>Account Type</th>
                        <th>Balance</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Subcategory</th>
                        <th>Statement Type</th>
                        <th>Comments</th>
                        <th>Opening Balance</th>
                        <th>Account Order</th>
                        <th>Total Debits</th>
                        <th>Total Credits</th>
                        <th>Actions</th>
                    </tr>
                    <% accounts.forEach(function(account) { %>
                    <tr>
                        <td><%= account.account_name %></td>
                        <td><%= (allUsers.find(function(user) { return user.id == account.user_id; }) || {}).username || "" %></td>
                        <td><%= account.normal_side.charAt(0).toUpperCase() + account.normal_side.slice(1) %></td>
                        <td data-is-currency><%= account.balance %></td>
                        <td data-long-text><%= account.account_description %></td>
                        <td><%= (allCategories.categories.find(function(category) { return category.id == account.account_category_id; }) || {}).name || "" %></td>
                        <td><%= (allCategories.subcategories.find(function(subcat) { return subcat.id == account.account_subcategory_id; }) || {}).name || "" %></td>
                        <td><%= {"IS":"Income Statement", "BS":"Balance Sheet", "RE":"Retained Earnings Statement"}[account.statement_type] || "" %></td>
                        <td data-long-text><%= account.comment %></td>
                        <td data-is-currency><%= account.initial_balance %></td>
                        <td><%= account.account_order %></td>
                        <td data-is-currency><%= account.total_debits %></td>
                        <td data-is-currency><%= account.total_credits %></td>
                        <td>
                            <button type="button" class="button-small account-button" data-account-id="<%= account.id %>" data-edit-account-button>Edit</button>
                            <button type="button" class="button-small account-button" data-account-id="<%= account.id %>" data-audit-account-button>Audit</button>
                        </td>
                    </tr>
                    <% }); %>
                </thead>
                <tbody data-accounts-list>
                    <!-- Accounts will be dynamically populated here -->
                </tbody>
            </table>
        </div>
    </div>
    <% if (role === 'administrator') { %>
    <section class="stack">
        <header class="page-header">
            <h1>System Management</h1>
            <!-- This section to manage system-wide settings related to accounts. Other system-wide settings can be added to the dashboard page. -->
        </header>
        <div class="grid">
            <article class="card">
                <h2>Account Categories & Subcategories</h2>
                <p class="meta">Manage account categories and subcategories used for organizing accounts.</p>
                <article>
                    <!-- list out categories and subcategories here -->
                    <% allCategories.categories.forEach(function(category) { %>
                    <article class="data-row">
                        <p class="value"><span><%= category.name %></span></p>
                    </article>
                    <% const subcats = allCategories.subcategories.filter(function(subcat) { return subcat.account_category_id === category.id; }); subcats.forEach(function(subcategory) { %>
                    <article class="data-row" style="margin-left: 20px">&mdash; <%= subcategory.name %></article>
                    <% }); }); %>
                </article>
                <article class="data-row">
                    <p>
                        <button type="button" class="button-primary" data-add-category-button>Add Category</button>
                        <button type="button" class="button-primary" data-add-subcategory-button>Add Subcategory</button>
                        <button type="button" class="button-primary" data-delete-category-button>Delete Category</button>
                    </p>
                </article>
            </article>
            <div class="stack">
                <article class="card">
                    <h2>Account Deactivation</h2>
                    <p class="meta">Deactivate accounts that are no longer in use to prevent further transactions.</p>
                    <% if (accounts.filter(function(account) { return account.status === 'inactive'; }).length == 0) { %>
                    <p>No inactive accounts found.</p>
                    <% } else { %>
                    <article class="data-row">
                        <h3>Inactive Accounts</h3>
                        <% accounts.filter(function(account) { return account.status === 'inactive'; }).forEach(function(account) { %>
                        <p class="value"><span><%= account.account_name %> (ID: <%= account.id %>)</span></p>
                        <% }); %>
                    </article>
                    <% } %>
                </article>
                <article class="card">
                    <form id="deactivate_account_form" class="stack">
                        <label for="deactivate_account_select">Select Account to Deactivate:</label>
                        <select id="deactivate_account_select" name="deactivate_account_select" required>
                            <% accounts.filter(function(account) { return account.status === 'active'; }).forEach(function(account) { %>
                            <option value="<%= account.id %>"><%= account.account_name %> (<%= account.account_number %>)</option>
                            <% }); %>
                        </select>
                        <button type="button" class="button-primary" id="deactivate_account_button">Deactivate Account</button>
                    </form>
                </article>
            </div>
        </div>
    </section>
    <div id="account_modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="close-button" id="close_account_modal" aria-label="Close">&times;</span>
            <h2 id="account_modal_title">Add/Edit Account</h2>
            <form id="account_form">
                <table>
                    <tr>
                        <td><label for="account_name">Account Name:</label></td>
                        <td><input type="text" id="account_name" name="account_name" required /></td>
                    </tr>
                    <tr>
                        <td><label for="account_description">Description:</label></td>
                        <td><textarea id="account_description" name="account_description"></textarea></td>
                    </tr>
                    <tr>
                        <td><label for="account_type">Normal Side:</label></td>
                        <td>
                            <select id="account_type" name="account_type" required>
                                <option value="debit">Debit</option>
                                <option value="credit">Credit</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="account_category">Category:</label></td>
                        <td>
                            <select id="account_category" name="account_category" required>
                                <% allCategories.categories.forEach(function(category) { %>
                                <option value="<%= category.id %>"><%= category.name %></option>
                                <% }); %>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="account_subcategory">Subcategory:</label></td>
                        <td>
                            <select id="account_subcategory" name="account_subcategory" required></select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="account_statement_type">Statement Type:</label></td>
                        <td>
                            <select id="account_statement_type" name="account_statement_type" required>
                                <option value="Income Statement">Income Statement</option>
                                <option value="Balance Sheet">Balance Sheet</option>
                                <option value="Retained Earnings Statement">Retained Earnings Statement</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="account_comments">Comments:</label></td>
                        <td><textarea id="account_comments" name="account_comments"></textarea></td>
                    </tr>
                    <tr>
                        <td><label for="initial_balance">Opening Balance ($):</label></td>
                        <td><input type="number" id="initial_balance" name="initial_balance" required data-is-currency /></td>
                    </tr>
                    <tr>
                        <td><label for="account_order">Account Order:</label></td>
                        <td><input type="number" id="account_order" name="account_order" required /></td>
                    </tr>
                    <tr>
                        <td>
                            <label for="account_owner">Account Owner:</label>
                        </td>
                        <td>
                            <select id="account_owner" name="account_owner" required>
                                <% allUsers.forEach(function(user) { %>
                                <option value="<%= user.id %>"><%= user.username %> (<%= user.last_name %>, <%= user.first_name %>)</option>
                                <% }); %>
                            </select>
                        </td>
                    </tr>
                </table>
                <button type="submit" class="button-primary" id="save_account_button">Save Account</button>
            </form>
        </div>
    </div>
    <% } %>
    <script id="accounts-data" type="application/json">
        <%- JSON.stringify({ accounts, allCategories }).replaceAll("</", "<\\/") %>
    </script>
</section>
